name: tests

on: [push, pull_request]

jobs:

  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
        # Oldest and newest versions should be enough. Python versions are supported 5 years from release date.
        # 3.5 was released 2015-09-13 and end-of-life was 2020-09-13
        # 3.6 was released 2016-12-23 and end-of-life will be 2021-12-23
        # 3.7 was released 2018-06-27 and end-of-life will be 2023-06-27
        # 3.8 was released 2019-10-14 and end-of-life will be 2024-10-14
        # 3.9 was released 2020-10-05 and end-of-life will be 2025-10-25
        # 3.10 is to be released 2021-10-25
        python-version: [3.6, 3.9]

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - if: matrix.os == 'ubuntu-latest'
      name: Install Dependencies
      run: |
        sudo apt-get -y install fuse bzip2 pbzip2 pixz zstd shellcheck # necessary for tests
    - name: Install pip Dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install --upgrade wheel
        python -m pip install --upgrade setuptools
        python -m pip install --upgrade-strategy eager --upgrade black cython flake8 mypy twine
    - name: Test Startup With Only One Compression Dependency
      run: |
        for module in indexed_gzip indexed_zstd lzmaffi; do
          python -m pip install --upgrade "$module"
          # Segfaults (139) are not allowed but other exit codes are valid!
          # indexed_zstd=1.2.0 did segfault here!
          python ratarmount.py README.md || [ $? != 139 ]
          python -m pip uninstall --yes "$module"
        done
        python -m pip install --upgrade git+https://github.com/mxmlnkn/indexed_bzip2.git@master#egginfo=indexed_bzip2
      if: matrix.os != 'windows-latest'
    - name: Test Installation From Tarball
      run: |
        python setup.py sdist bdist_wheel
        twine check dist/*
        python -m pip install "$( find dist -name '*.tar.gz' | head -1 )[full]"
    - name: Test Simple Startup
      run: |
        ratarmount --help
        ratarmount --version
        ratarmount tests/single-file.tar mimi; sleep 1s; fusermount -u mimi
    - name: Style Check With Black
      run: |
        black -q --diff --line-length 120 --skip-string-normalization ratarmount.py > black.diff
        ! [ -s black.diff ]
      if: matrix.os == 'ubuntu-latest'
    - name: Lint With Flake8
      run: flake8 *.py
      if: matrix.os == 'ubuntu-latest'
    - name: Lint With Pylint
      run: |
        python -m pip install pylint
        pylint *.py | tee pylint.log
        ! 'egrep' ': E[0-9]{4}: ' pylint.log
      if: matrix.os == 'ubuntu-latest'
    - name: Lint With Pytype
      run: |
        python -m pip install pytype
        pytype -d import-error ratarmount.py
      if: |
        (matrix.python-version == '3.9') &&
        (matrix.os == 'ubuntu-latest')
    - name: Lint With Mypy
      run: |
        yes | python -m pip install --upgrade-strategy eager --upgrade types-dataclasses mypy
        mypy *.py
        yes | python -m pip uninstall types-dataclasses
      if: matrix.os == 'ubuntu-latest'
    - name: Lint With ShellCheck
      run: shellcheck -e SC2064 tests/*.sh
      if: matrix.os == 'ubuntu-latest'
    - name: Test Startup Without Compression Dependencies
      run: |
        # Segfaults (139) are not allowed but other exit codes are valid!
        python ratarmount.py tests/simple.bz2 || [ $? != 139 ]
    - name: Regression Tests
      run: |
        bash tests/runtests.sh
    - name: Module tests without fusepy
      run: |
        python -m pip uninstall -y fusepy
        python tests/tests.py
